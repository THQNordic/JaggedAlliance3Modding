-- ========== GENERATED BY QuestsDef Editor (Ctrl-Alt-Q) DO NOT EDIT MANUALLY! ==========

PlaceObj('QuestsDef', {
	Author = "Diogo",
	Chapter = "Utility",
	DevNotes = 'This quest checks the conditions for unlocking the shop the first tier and each subsequent tier.\n\nActual unlock behaviour and e-mails are sent with "ExecuteCode".\n\nOne "hack" is the use of the BlockingEmails and DelayAfterEmailSent variables so that we don\'t send multiple e-mails at once when a player loads an old save, before the shop was implemented, and every tier unlocks at once.\nWhen the condition to open shop is satisfied, there is a 1 day timer before the shop actually opens. When it does, an e-mail is sent, and the tiers are checked.\nIn usual circumstances, unlocking a new tier will send an e-mail. If the shop has been "open" for less than 24h, however, no e-mail will be sent (the "ShopNowOpen" e-mail will suffice).',
	NoteDefs = {
		LastNoteIdx = 1,
	},
	TCEs = {
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('AND', {
					Conditions = {
						PlaceObj('QuestIsTCEState', {
							Prop = "TCE_ResolveQuest",
							QuestId = "02_LiberateErnie",
							Value = "done",
						}),
						PlaceObj('IsTimeOfDay', {}),
					},
				}),
			},
			Effects = {
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("------------ Shop preparing to open with Quest (1 day)")',
				}),
				PlaceObj('QuestSetVariableTimer', {
					Prop = "DelayBeforeOpening",
					QuestId = "BobbyRayQuest",
					TimeAmount = 24,
				}),
			},
			Once = true,
			ParamId = "TCE_PreparingToOpen",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('QuestHasTimerPassed', {
					QuestId = "BobbyRayQuest",
					TimerVariable = "DelayBeforeOpening",
				}),
			},
			Effects = {
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("--------------------- Store is now Open with Quest")\nReceiveEmail("BobbyRayShopNowOpen")\nassert(PDABrowserTabState.bobby_ray_shop)\nDockBrowserTab("bobby_ray_shop")',
				}),
				PlaceObj('QuestSetVariableTimer', {
					Prop = "DelayAfterEmailSent",
					QuestId = "BobbyRayQuest",
					TimeAmount = 24,
				}),
				PlaceObj('QuestSetVariableTimer', {
					Prop = "RestockTimer",
					QuestId = "BobbyRayQuest",
					TimeAmount = 1,
					Timescale = "sec",
				}),
				PlaceObj('QuestSetVariableTimer', {
					Prop = "FakePurchasesTimer",
					QuestId = "BobbyRayQuest",
					TimeAmount = 24,
				}),
				PlaceObj('QuestSetVariableBool', {
					Prop = "BlockingEmails",
					QuestId = "BobbyRayQuest",
				}),
			},
			Once = true,
			ParamId = "TCE_StoreNowOpen",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('AND', {
					Conditions = {
						PlaceObj('QuestHasTimerPassed', {
							QuestId = "BobbyRayQuest",
							TimerVariable = "DelayBeforeOpening",
						}),
						PlaceObj('QuestIsVariableNum', {
							Condition = "==",
							Prop = "UnlockedTier",
							QuestId = "BobbyRayQuest",
						}),
					},
				}),
			},
			Effects = {
				PlaceObj('ExecuteCode', {
					Code = function (self, obj)
						print("---------------------------- unlocking tier 1 shop with quest")
					end,
					FuncCode = 'bobby_tier_print("---------------------------- unlocking tier 1 shop with quest")',
				}),
				PlaceObj('QuestSetVariableNum', {
					Amount = 1,
					Operation = "set",
					Prop = "UnlockedTier",
					QuestId = "BobbyRayQuest",
				}),
			},
			Once = true,
			ParamId = "TCE_Tier1Unlock",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('AND', {
					Conditions = {
						PlaceObj('QuestHasTimerPassed', {
							QuestId = "BobbyRayQuest",
							TimerVariable = "DelayBeforeOpening",
						}),
						PlaceObj('PlayerControlSectors', {
							Amount = 2,
							Condition = ">=",
							POIs = "Mine",
						}),
						PlaceObj('QuestIsVariableNum', {
							Amount = 1,
							Condition = "<=",
							Prop = "UnlockedTier",
							QuestId = "BobbyRayQuest",
						}),
					},
				}),
			},
			Effects = {
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("--------------------------- unlocking tier 2 shops with quest")\nif obj.BlockingEmails then\n	bobby_tier_print("\\t\\tEmail timer not yet passed, will not send e-mail...")\nelse\n	bobby_tier_print("\\t\\tSending e-mail!")\n	ReceiveEmail("BobbyRayShopTier2Unlocked")\nend',
				}),
				PlaceObj('QuestSetVariableNum', {
					Amount = 2,
					Operation = "set",
					Prop = "UnlockedTier",
					QuestId = "BobbyRayQuest",
				}),
			},
			Once = true,
			ParamId = "TCE_Tier2Unlock",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('AND', {
					Conditions = {
						PlaceObj('QuestIsVariableBool', {
							Condition = "or",
							QuestId = "04_Betrayal",
							Vars = set( "TriggerWorldFlip", "WorldFlipDone" ),
							__eval = function ()
								local quest = gv_Quests['04_Betrayal'] or QuestGetState('04_Betrayal')
								return quest.TriggerWorldFlip or quest.WorldFlipDone
							end,
						}),
						PlaceObj('QuestHasTimerPassed', {
							QuestId = "BobbyRayQuest",
							TimerVariable = "DelayBeforeOpening",
						}),
						PlaceObj('QuestIsVariableNum', {
							Amount = 2,
							Condition = "<=",
							Prop = "UnlockedTier",
							QuestId = "BobbyRayQuest",
						}),
					},
				}),
			},
			Effects = {
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("--------------------- unlocking tier 3 with quest")\nif obj.BlockingEmails then\n	bobby_tier_print("\\t\\tEmail timer not yet passed, will not send e-mail...")\nelse\n	bobby_tier_print("\\t\\tSending e-mail!")\n	ReceiveEmail("BobbyRayShopTier3Unlocked")\nend',
				}),
				PlaceObj('QuestSetVariableNum', {
					Amount = 3,
					Operation = "set",
					Prop = "UnlockedTier",
					QuestId = "BobbyRayQuest",
				}),
			},
			Once = true,
			ParamId = "TCE_Tier3Unlock",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('QuestHasTimerPassed', {
					QuestId = "BobbyRayQuest",
					TimerVariable = "DelayAfterEmailSent",
				}),
			},
			Effects = {
				PlaceObj('QuestSetVariableBool', {
					Prop = "BlockingEmails",
					QuestId = "BobbyRayQuest",
					Set = false,
				}),
			},
			ParamId = "TCE_EmailDelay",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('QuestHasTimerPassed', {
					QuestId = "BobbyRayQuest",
					TimerVariable = "RestockTimer",
				}),
			},
			Effects = {
				PlaceObj('QuestSetVariableTimer', {
					Prop = "RestockTimer",
					QuestId = "BobbyRayQuest",
					TimeAmount = 120,
				}),
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("---------------------------- Restocking shop with Quest")\nBobbyRayStoreRestock()',
				}),
			},
			ParamId = "TCE_ShopRestock",
			QuestId = "BobbyRayQuest",
		}),
		PlaceObj('TriggeredConditionalEvent', {
			Conditions = {
				PlaceObj('QuestHasTimerPassed', {
					QuestId = "BobbyRayQuest",
					TimerVariable = "FakePurchasesTimer",
				}),
			},
			Effects = {
				PlaceObj('QuestSetVariableTimer', {
					Prop = "FakePurchasesTimer",
					QuestId = "BobbyRayQuest",
					TimeAmount = 10,
					TimeAmountRangeMax = 14,
				}),
				PlaceObj('ExecuteCode', {
					FuncCode = 'bobby_tier_print("---------------------------- Consuming random shop stock with Quest")\nBobbyRayStoreConsumeRandomStock()',
				}),
			},
			ParamId = "TCE_ShopFakePurchase",
			QuestId = "BobbyRayQuest",
		}),
	},
	Variables = {
		PlaceObj('QuestVarBool', {
			Name = "Completed",
		}),
		PlaceObj('QuestVarBool', {
			Name = "Given",
		}),
		PlaceObj('QuestVarBool', {
			Name = "Failed",
		}),
		PlaceObj('QuestVarBool', {
			Name = "NotStarted",
			Value = true,
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_Tier1Unlock",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_Tier2Unlock",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_Tier3Unlock",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_PreparingToOpen",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_StoreNowOpen",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_EmailDelay",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_ShopRestock",
		}),
		PlaceObj('QuestVarTCEState', {
			Name = "TCE_ShopFakePurchase",
		}),
		PlaceObj('QuestVarNum', {
			Name = "DelayBeforeOpening",
		}),
		PlaceObj('QuestVarNum', {
			Name = "DelayAfterEmailSent",
		}),
		PlaceObj('QuestVarNum', {
			Name = "RestockTimer",
		}),
		PlaceObj('QuestVarNum', {
			Name = "FakePurchasesTimer",
		}),
		PlaceObj('QuestVarBool', {
			Name = "BlockingEmails",
		}),
		PlaceObj('QuestVarNum', {
			Name = "UnlockedTier",
		}),
	},
	group = "BobbyRay",
	id = "BobbyRayQuest",
})

