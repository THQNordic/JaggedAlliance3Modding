-- ========== GENERATED BY CharacterEffectCompositeDef Editor DO NOT EDIT MANUALLY! ==========

PlaceObj('CharacterEffectCompositeDef', {
	'Group', "System",
	'Id', "Unconscious",
	'Parameters', {
		PlaceObj('PresetParamNumber', {
			'Name', "recovery_delay_turns",
			'Value', 2,
			'Tag', "<recovery_delay_turns>",
		}),
		PlaceObj('PresetParamNumber', {
			'Name', "recovery_delay_seconds",
			'Value', 10,
			'Tag', "<recovery_delay_seconds>",
		}),
	},
	'object_class', "CharacterEffect",
	'msg_reactions', {
		PlaceObj('MsgReactionEffects', {
			Effects = {
				PlaceObj('ConditionalEffect', {
					'Effects', {
						PlaceObj('ExecuteCode', {
							Code = function (self, obj)
								if not IsKindOf(obj, "Unit") then return end
								local recovery = obj:GetEffectValue("unconscious_recovery_exploration_time") 
								if recovery and GameTime() >= recovery then
									obj:SetTired(const.utExhausted)
									obj:SetCommand("DownedRally")
								end
							end,
							FuncCode = 'if not IsKindOf(obj, "Unit") then return end\nlocal recovery = obj:GetEffectValue("unconscious_recovery_exploration_time") \nif recovery and GameTime() >= recovery then\n	obj:SetTired(const.utExhausted)\n	obj:SetCommand("DownedRally")\nend',
							SaveAsText = false,
						}),
					},
				}),
			},
			Event = "ExplorationTick",
			Handler = function (self)
				CE_ExecReactionEffects(self, "ExplorationTick")
			end,
		}),
		PlaceObj('MsgReaction', {
			Event = "StatusEffectAdded",
			Handler = function (self, obj, id, stacks)
				local reaction_idx = table.find(self.msg_reactions or empty_table, "Event", "StatusEffectAdded")
				if not reaction_idx then return end
				
				local function exec(self, obj, id, stacks)
				local delay = self:ResolveValue("recovery_delay_turns")
				local recovery_turn = (g_Combat and g_Combat.current_turn or 1) + delay
				obj:SetEffectValue("unconscious_recovery_turn", recovery_turn)
				if not g_Combat then
					local delay = self:ResolveValue("recovery_delay_seconds") * 1000
					obj:SetEffectValue("unconscious_recovery_exploration_time", GameTime() + delay)
				end
				obj:AddStatusEffectImmunity("Surprised", id)
				CreateGameTimeThread(obj.SetCommandIfNotDead, obj, obj.command == "GetDowned" and "Downed" or "KnockDown")
				end
				local _id = GetCharacterEffectId(self)
				if _id == id then exec(self, obj, id, stacks) end
				
			end,
			HandlerCode = function (self, obj, id, stacks)
				local delay = self:ResolveValue("recovery_delay_turns")
				local recovery_turn = (g_Combat and g_Combat.current_turn or 1) + delay
				obj:SetEffectValue("unconscious_recovery_turn", recovery_turn)
				if not g_Combat then
					local delay = self:ResolveValue("recovery_delay_seconds") * 1000
					obj:SetEffectValue("unconscious_recovery_exploration_time", GameTime() + delay)
				end
				obj:AddStatusEffectImmunity("Surprised", id)
				CreateGameTimeThread(obj.SetCommandIfNotDead, obj, obj.command == "GetDowned" and "Downed" or "KnockDown")
			end,
		}),
		PlaceObj('MsgReaction', {
			Event = "StatusEffectRemoved",
			Handler = function (self, obj, id, stacks, reason)
				local reaction_idx = table.find(self.msg_reactions or empty_table, "Event", "StatusEffectRemoved")
				if not reaction_idx then return end
				
				local function exec(self, obj, id, stacks, reason)
				obj:SetEffectValue("unconscious_recovery_turn")
				obj:SetEffectValue("unconscious_recovery_exploration_time")
				obj:RemoveStatusEffectImmunity("Surprised", id)
				if obj.command == "Downed" then
					obj:SetCommand("DownedRally")
				else
					obj:SetTired(Min(obj.Tiredness, const.utExhausted))
				end
				end
				local _id = GetCharacterEffectId(self)
				if _id == id then exec(self, obj, id, stacks, reason) end
				
			end,
			HandlerCode = function (self, obj, id, stacks, reason)
				obj:SetEffectValue("unconscious_recovery_turn")
				obj:SetEffectValue("unconscious_recovery_exploration_time")
				obj:RemoveStatusEffectImmunity("Surprised", id)
				if obj.command == "Downed" then
					obj:SetCommand("DownedRally")
				else
					obj:SetTired(Min(obj.Tiredness, const.utExhausted))
				end
			end,
		}),
		PlaceObj('MsgReaction', {
			Event = "UnitBeginTurn",
			Handler = function (self, unit)
				local reaction_idx = table.find(self.msg_reactions or empty_table, "Event", "UnitBeginTurn")
				if not reaction_idx then return end
				
				local function exec(self, unit)
				local recovery_turn = unit:GetEffectValue("unconscious_recovery_turn") or -1
				local rally = unit:GetEffectValue("stabilized")
				if not rally and g_Combat and g_Combat.current_turn >= recovery_turn then
					rally = RollSkillCheck(unit, "Health", 50)
				end
				if rally and unit:IsDowned() then
					unit:SetCommand("DownedRally")
				end
				end
				local id = GetCharacterEffectId(self)
				
				if id then
					if IsKindOf(unit, "StatusEffectObject") and unit:HasStatusEffect(id) then
						exec(self, unit)
					end
				else
					exec(self, unit)
				end
				
			end,
			HandlerCode = function (self, unit)
				local recovery_turn = unit:GetEffectValue("unconscious_recovery_turn") or -1
				local rally = unit:GetEffectValue("stabilized")
				if not rally and g_Combat and g_Combat.current_turn >= recovery_turn then
					rally = RollSkillCheck(unit, "Health", 50)
				end
				if rally and unit:IsDowned() then
					unit:SetCommand("DownedRally")
				end
			end,
		}),
	},
	'DisplayName', T(132204403941, --[[CharacterEffectCompositeDef Unconscious DisplayName]] "Unconscious"),
	'Description', T(801008446056, --[[CharacterEffectCompositeDef Unconscious Description]] "Unconscious and unable to take any action. "),
	'AddEffectText', T(964785237678, --[[CharacterEffectCompositeDef Unconscious AddEffectText]] "<em><DisplayName></em> is unconscious"),
	'RemoveEffectText', T(208147554823, --[[CharacterEffectCompositeDef Unconscious RemoveEffectText]] "<em><DisplayName></em> regained consciousness"),
	'Icon', "UI/Hud/Status effects/unconscious",
	'Shown', true,
	'ShownSatelliteView', true,
	'HasFloatingText', true,
})

